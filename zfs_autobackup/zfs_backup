#!/bin/bash

set -e

HOST=$1
SRC=$2
DST=$3
SNAP_FORMAT=$4

if ! [ "$SNAP_FORMAT" ]; then
    SNAP_FORMAT="autobackup"
fi

echo "Backupping from $HOST:$SRC to $DST"

LATEST_REMOTE=`ssh $HOST "zfs list -r -t snapshot -H -o name $SRC 2>/dev/null"|grep @$SNAP_FORMAT- |tail -1`
LATEST_REMOTE_SNAPSHOT=@`echo $LATEST_REMOTE | cut -f2 -d@`
echo "Latest remote snapshot: $LATEST_REMOTE_SNAPSHOT"

#ignore errors if there is no local fs yet
LATEST_LOCAL=`zfs list -r -t snapshot -H -o name $DST 2>/dev/null|grep @$SNAP_FORMAT- |tail -1`
LATEST_LOCAL_SNAPSHOT=@`echo $LATEST_LOCAL | cut -f2 -d@`
echo "Latest local snapshot : $LATEST_LOCAL_SNAPSHOT"



if [ "$LATEST_LOCAL_SNAPSHOT" == "$LATEST_REMOTE_SNAPSHOT" ]; then
    #create new remote snapshot
    NEW_SNAPSHOT="$SNAP_FORMAT-`date +%s`"
    echo "Last backup complete, creating snapshot $NEW_SNAPSHOT"
    ssh $HOST "zfs snapshot -r $SRC@$NEW_SNAPSHOT"
    LATEST_REMOTE_SNAPSHOT=@$NEW_SNAPSHOT
fi


if [ "$LATEST_LOCAL" == "" ]; then
    echo "No local snapshots, performing initial full send..."
    LATEST_LOCAL="IGNOREME";
else
    echo "Requesting incremental data from $LATEST_LOCAL_SNAPSHOT to $LATEST_REMOTE_SNAPSHOT..."
fi
    
ssh $HOST "zfs send -v -D -R -i $LATEST_LOCAL_SNAPSHOT $SRC$LATEST_REMOTE_SNAPSHOT | gzip" | gunzip | zfs recv -v "$DST"


echo "Checking old remote snapshots that we created..."
OLD_REMOTES=`ssh $HOST "zfs list -r -t snapshot -H -o name $SRC 2>/dev/null"|grep @$SNAP_FORMAT- |grep -v "$LATEST_LOCAL_SNAPSHOT"| grep -v "$LATEST_REMOTE_SNAPSHOT"` || true
for OLD_REMOTE in $OLD_REMOTES; do
    echo "Destroying old remote snapshot $OLD_REMOTE..."
    ssh $HOST "zfs destroy $OLD_REMOTE"
done

KEEP=30
echo "Keeping $KEEP local snapshots, deleting older ones:"
OLD_LOCALS=`zfs list -r -t snapshot -H -o name $DST|grep @$SNAP_FORMAT- |grep -v "$LATEST_LOCAL_SNAPSHOT"| grep -v "$LATEST_REMOTE_SNAPSHOT"`
COUNT=`echo $OLD_LOCALS|wc -w`
for OLD_LOCAL in $OLD_LOCALS; do
    if [ $COUNT -gt $KEEP ]; then
	echo "Destroying old local snapshot $OLD_LOCAL"
	zfs destroy $OLD_LOCAL
	(( COUNT=COUNT-1 ))
    fi    
done

exit 0

